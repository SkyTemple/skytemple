Windows development setup
-------------------------

All of these commands should be run in the MSys environment that is set up in step 1.

1. Install Python and the Pygobject dependencies, as explained here (for development!):
   https://pygobject.readthedocs.io/en/latest/getting_started.html#windows-getting-started
2. Install additional packages. An up to date list of all the required packages can be found in the workflow files:
   - https://github.com/SkyTemple/skytemple/blob/master/.github/workflows/build-test-publish.yml (jobs > package_windows > steps > "Install MSys2 and dependencies" > install).
   - https://github.com/SkyTemple/skytemple-rust/blob/master/.github/workflows/build-test-publish.yml (jobs > build_mingw > steps > "Install MSys2 and dependencies" > install).
   
   For each one of the packages listed there, run `pacman -S <package name>`, replacing `${{ matrix.arch }}` with the right value depending on whether you have a 64-bit system (`x86_64`) or a 32-bit one (`i686`).
   
   Some examples:
   ```
   pacman -S unzip
   pacman -S mingw-w64-x86_64-curl
   pacman -S mingw-w64-x86_64-gettext
   ...
   ```
3. Download the required binary wheels from https://skytemple.org/build_deps/, place them in the folder where you're making the installation, then run `pip install` for each one of them. You only have to download one version for each wheel (usually the latest one available for your platform).
   ```
   pip install py_desmume-0.0.3-cp39-cp39-mingw_x86_64.whl
   pip install python_igraph-0.8.2-cp39-cp39-mingw_x86_64.whl
   pip install skytemple_rust-1.3.4.post0-cp39-cp39-mingw_x86_64.whl
   pip install tilequant-0.4.0.post0-cp39-cp39-mingw_x86_64.whl
   ```
   If you want to know how to build these yourself, see "Building binary dependencies".
4. Clone the SkyTemple repositories:
   - https://github.com/SkyTemple/tilequant.git
   - https://github.com/SkyTemple/explorerscript.git
   - https://github.com/SkyTemple/skytemple-files.git
   - https://github.com/SkyTemple/skytemple-ssb-debugger.git
   - https://github.com/SkyTemple/skytemple-randomizer.git
   - https://github.com/SkyTemple/skytemple.git
5. Inside each of the repositories listed above (IN THE SAME ORDER AS LISTED), execute:
   ```
   pip install -e .
   ```
   This installs the package in "editable" mode, meaning changes you make to it will be applied directly; 
   the package is installed directly from source (under Linux it uses Symlinks, don't know how it does it for Windows).
   You can also skip cloning some repositories. For example if you only clone SkyTemple and run the above command,
   all of the other sub-projects will be downloaded from PyPi. You won't be able to work on them then.
6. You should be good to go:
   ```
   # Run SkyTemple main UI:
   python -m skytemple.main
   # Run the randomizer
   python3 -m skytemple_randomizer.frontend.gtk.main
   # Run ExplorerScript test export/import script (warning, hardcoded to my machine by default. The other packages have similar debug scripts):
   python -m skytemple_files.script.ssb.dbg.export_explorerscript_test
   ```

Keeping up with updates
-------------------------
If you want to keep your local setup up to date, you'll have to do the following:
1. If there's new packages that have been added to the requirements and you don't have them, you'll have to install them just like you did in step 2.
2. Download the latest version of the wheels. https://skytemple.org/build_deps/ is only updated every now and then; if you need the latest wheels you can grab them from the artifacts generated by action runs (https://github.com/SkyTemple/skytemple/actions). Then you install them just like in step 3.
3. Pull the latest changes from the upstream repositories. Make sure to update all of them since new features from one of them might require new features from some of the others.
4. Run `pip install -e .` again in each one of the repositories

Building binary dependencies
----------------------------

### skytemple_rust
1. Make sure you have a Rust toolchain (nightly) setup in MingW.
2. Clone https://github.com/SkyTemple/skytemple-rust.git
3. Create the following symlink (PyO3, the lib that creates the Python bindings, requires python38 without the dot):
   ln -s /mingw64/lib/libpython3.8.dll.a /mingw64/lib/libpython38.dll.a
4. Run `pip install -e .`

### python-igraph
1. Clone Python Igraph with this Pull Request applied:
   https://github.com/igraph/python-igraph/pull/297
2. Install the dependencies of python-igraph.
3. Run `pip install -e .`

### py-desmume
1. Clone https://github.com/SkyTemple/desmume
2. Checkout the `binary-interface` branch.
3. Go to `desmume/src/frontend/interface/windows` and build the Visual Studio project in there.
4. Clone https://github.com/SkyTemple/py-desmume
5. Put the output DLL of step 3 inside the `desmume` directory of that repo.
6. Run `pip install -e .`

Troubleshooting
-------------------------
- I get an "armips could not be found" error when trying to apply ASM patches
   - A: Add the path to the armips executable (https://github.com/Kingcom/armips) to your PATH. You can also copy the executable into `skytemple-files/skytemple_files/_resources`.
- I get the error message `ERROR: xxx is not a supported wheel on this platform` when trying to install some of the wheels
   - A: Try upgrading everything by running `pacman -Syu`.
